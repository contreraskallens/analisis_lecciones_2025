labels = c(
"Ausente",
"Nulos\nBlancos",
"Otros",
"Kaiser",
"Kast",
"Matthei",
"Parisi",
"Jara"
)
)
ptm_comuna$vuelta_2 <- factor(
ptm_comuna$vuelta_2,
levels = c(
"ausente",
"nulos_blancos",
"kast",
"jara"
),
labels = c(
"Ausente",
"Nulos/Blancos",
"Kast",
"Jara"
)
)
matriz_comuna <- ptm_comuna %>%
ggplot(
aes(
x = vuelta_1,
y = vuelta_2,
fill = prop_votos,
label = round(prop_votos, digits = 1)
)
) +
geom_tile(color = "black") +
geom_text(size = 6) +
scale_fill_gradientn(colours = brewer.pal(n = 8, name = "OrRd")) +
hrbrthemes::theme_ipsum_rc() +
labs(
title = str_c(
"Matriz de traspaso de votos para ",
str_to_title(nombre_comuna)
),
x = "Primera vuelta",
y = "Segunda vuelta"
) +
theme(
legend.position = "none",
axis.title.x = element_text(size = 14),
axis.text.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
axis.text.y = element_text(size = 14)
)
ggsave(
str_c(
"matrices/",
str_to_snake(nombre_comuna),
"_matriz.png"
),
width = 10,
height = 6,
bg = "white",
dpi = 300
)
vtm_wide <- ei_comuna$VTM.votes %>%
as.data.frame() %>%
rownames_to_column(var = "vuelta_1") %>%
mutate(
vuelta_1 = ifelse(
vuelta_1 == "nulos_blancos",
"nulosblancos",
vuelta_1
)
) %>%
rename(
ausente2 = ausente,
nulosblancos2 = nulos_blancos,
kast2 = kast,
jara2 = jara
) %>%
pivot_wider(
names_from = vuelta_1,
values_from = c(
ausente2,
nulosblancos2,
kast2,
jara2
) # Sin snakecase para dividirlo después por "_"
) %>%
mutate_if(is.numeric, round)
vtm_wide$comuna <- nombre_comuna
write_csv(
vtm_wide,
str_c(
"vtm/",
str_to_snake(nombre_comuna),
"_vtm.csv"
)
)
ptm_wide <- ei_comuna$VTM %>%
as.data.frame() %>%
rownames_to_column(var = "vuelta_1") %>%
mutate(
vuelta_1 = ifelse(
vuelta_1 == "nulos_blancos",
"nulosblancos",
vuelta_1
)
) %>%
rename(
ausente2 = ausente,
nulosblancos2 = nulos_blancos,
kast2 = kast,
jara2 = jara
) %>%
pivot_wider(
names_from = vuelta_1,
values_from = c(ausente2, nulosblancos2, kast2, jara2)
) %>%
mutate_if(is.numeric, round, digits = 3)
ptm_wide$comuna <- nombre_comuna
write_csv(
ptm_wide,
str_c(
"ptm/",
str_to_snake(nombre_comuna),
"_ptm.csv"
)
)
}
problemas <- c()
for (comuna in codigo_comuna$comuna) {
print(comuna)
tryCatch(
{
analizar_comuna(comuna)
},
error = function(e) {
problemas <- c(problemas, comuna)
}
)
}
matriz_comuna <- ptm_comuna %>%
ggplot(
aes(
x = vuelta_1,
y = vuelta_2,
fill = prop_votos,
label = round(prop_votos, digits = 1)
)
) +
geom_tile(color = "black") +
geom_text(size = 6) +
scale_fill_gradientn(colours = brewer.pal(n = 8, name = "OrRd")) +
hrbrthemes::theme_ipsum_rc() +
labs(
title = str_c(
"Matriz de traspaso de votos para ",
str_to_title(nombre_comuna)
),
subtitle = str_c(
"Numero de mesas: ",
nrow(datos_comuna)
),
x = "Primera vuelta",
y = "Segunda vuelta"
) +
theme(
legend.position = "none",
axis.title.x = element_text(size = 14),
axis.text.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
axis.text.y = element_text(size = 14)
)
flujo_comuna
matriz
matriz_comuna
# NO FUNCIONAN: ANTOFAGASTA, CONCEPCION, COMUNAS CON MENOS DE 10 mesas?
analizar_comuna <- function(nombre_comuna) {
datos_comuna <- filter(ambas_vueltas, comuna == nombre_comuna)
n_original <- nrow(datos_comuna)
while (nrow(datos_comuna) > 100) {
if (nrow(datos_comuna) %% 10 == 0) {
print(str_c("Consolidando mesas, ", nrow(datos_comuna), " restantes"))
}
mayor_local <- datos_comuna %>%
group_by(id_local) %>%
tally() %>%
arrange(desc(n)) %>%
head(1) %>%
.$id_local
# print(mayor_local)
menores_mesas <- datos_comuna %>%
filter(id_local == mayor_local) %>%
arrange(total_2) %>%
head(2) %>%
.$id_mesa
# print(menores_mesas)
menores_mesas_consolidadas <- datos_comuna %>%
filter(id_mesa %in% menores_mesas) %>%
summarize_if(is.numeric, sum)
menores_mesas_consolidadas$id_local <- mayor_local[[1]]
menores_mesas_consolidadas$id_mesa <- sample(menores_mesas, 1)
# print(menores_mesas_consolidadas)
datos_comuna <- datos_comuna %>%
filter(!(id_mesa %in% menores_mesas)) %>%
bind_rows(menores_mesas_consolidadas)
}
n_consolidado <- nrow(datos_comuna)
primera_vuelta <- datos_comuna %>%
select(
ausente,
matthei,
parisi,
kaiser,
kast,
jara,
otros,
nulos_blancos
)
segunda_vuelta <- datos_comuna %>%
select(
ausente = ausente_2,
nulos_blancos = nulos_blancos_2,
kast = kast_2,
jara = jara_2
)
ei_comuna <- eiopt2(
primera_vuelta,
segunda_vuelta,
census.changes = "adjust2",
trace = TRUE
)
vtm_comuna <- ei_comuna$VTM.votes %>%
data.frame() %>%
rownames_to_column(var = "opcion_1_vuelta") %>%
pivot_longer(
-opcion_1_vuelta,
names_to = "opcion_2_vuelta",
values_to = "prop_votos"
)
vtm_comuna$opcion_1_vuelta <- factor(
vtm_comuna$opcion_1_vuelta,
levels = c(
"jara",
"parisi",
"matthei",
"kast",
"kaiser",
"otros",
"nulos_blancos",
"ausente"
),
labels = c(
"Jara",
"Parisi",
"Matthei",
"Kast",
"Kaiser",
"Otros",
"Nulos/Blancos",
"Ausente"
)
)
vtm_comuna$opcion_2_vuelta <- factor(
vtm_comuna$opcion_2_vuelta,
levels = c(
"jara",
"kast",
"nulos_blancos",
"ausente"
),
labels = c(
"Jara",
"Kast",
"Nulos/Blancos",
"Ausente"
)
)
flujo_comuna <- ggplot(
vtm_comuna,
aes(
axis1 = opcion_1_vuelta,
axis2 = opcion_2_vuelta,
y = prop_votos
)
) +
geom_alluvium(aes(fill = opcion_1_vuelta)) +
geom_stratum() +
geom_text(
stat = "stratum",
aes(label = after_stat(stratum))
) +
scale_x_discrete(
name = "Elección",
limits = c("Primera vuelta", "Segunda vuelta")
) +
labs(
title = str_c(
"Flujo de votos para ",
str_to_title(nombre_comuna)
),
subtitle = str_c(
"Numero de mesas: ",
nrow(datos_comuna)
),
y = "Votos"
) +
hrbrthemes::theme_ipsum_rc() +
scale_fill_manual(
values = c(
Jara = palette_alluvial[1],
Kast = palette_alluvial[5],
Kaiser = palette_alluvial[6],
Matthei = palette_alluvial[4],
Parisi = palette_alluvial[2],
Otros = palette_alluvial[3],
"Nulos/Blancos" = palette_alluvial[7],
Ausente = palette_alluvial[8]
)
) +
theme(
legend.position = "none",
axis.title.y = element_blank(),
axis.text.y = element_blank(),
panel.grid = element_blank(),
axis.title.x = element_text(
size = 20
)
)
ggsave(
str_c(
"flujos/",
str_to_snake(nombre_comuna),
"_flujo.png"
),
flujo_comuna,
bg = "white", width = 8,
height = 10
)
ptm_comuna <- ei_comuna$VTM %>%
as.data.frame() %>%
rownames_to_column(var = "vuelta_1") %>%
pivot_longer(
-vuelta_1,
names_to = "vuelta_2",
values_to = "prop_votos"
)
ptm_comuna$vuelta_1 <- factor(
ptm_comuna$vuelta_1,
levels = c(
"ausente",
"nulos_blancos",
"otros",
"kaiser",
"kast",
"matthei",
"parisi",
"jara"
),
labels = c(
"Ausente",
"Nulos\nBlancos",
"Otros",
"Kaiser",
"Kast",
"Matthei",
"Parisi",
"Jara"
)
)
ptm_comuna$vuelta_2 <- factor(
ptm_comuna$vuelta_2,
levels = c(
"ausente",
"nulos_blancos",
"kast",
"jara"
),
labels = c(
"Ausente",
"Nulos/Blancos",
"Kast",
"Jara"
)
)
matriz_comuna <- ptm_comuna %>%
ggplot(
aes(
x = vuelta_1,
y = vuelta_2,
fill = prop_votos,
label = round(prop_votos, digits = 1)
)
) +
geom_tile(color = "black") +
geom_text(size = 6) +
scale_fill_gradientn(colours = brewer.pal(n = 8, name = "OrRd")) +
hrbrthemes::theme_ipsum_rc() +
labs(
title = str_c(
"Matriz de traspaso de votos para ",
str_to_title(nombre_comuna)
),
subtitle = str_c(
"Numero de mesas: ",
nrow(datos_comuna)
),
x = "Primera vuelta",
y = "Segunda vuelta"
) +
theme(
legend.position = "none",
axis.title.x = element_text(size = 14),
axis.text.x = element_text(size = 14),
axis.title.y = element_text(size = 14),
axis.text.y = element_text(size = 14)
)
ggsave(
str_c(
"matrices/",
str_to_snake(nombre_comuna),
"_matriz.png"
),
width = 10,
height = 6,
bg = "white",
dpi = 300
)
vtm_wide <- ei_comuna$VTM.votes %>%
as.data.frame() %>%
rownames_to_column(var = "vuelta_1") %>%
mutate(
vuelta_1 = ifelse(
vuelta_1 == "nulos_blancos",
"nulosblancos",
vuelta_1
)
) %>%
rename(
ausente2 = ausente,
nulosblancos2 = nulos_blancos,
kast2 = kast,
jara2 = jara
) %>%
pivot_wider(
names_from = vuelta_1,
values_from = c(
ausente2,
nulosblancos2,
kast2,
jara2
) # Sin snakecase para dividirlo después por "_"
) %>%
mutate_if(is.numeric, round)
vtm_wide$comuna <- nombre_comuna
vtm_wide$n_original <- n_original
vtm_wide$n_consolidado <- n_consolidado
write_csv(
vtm_wide,
str_c(
"vtm/",
str_to_snake(nombre_comuna),
"_vtm.csv"
)
)
ptm_wide <- ei_comuna$VTM %>%
as.data.frame() %>%
rownames_to_column(var = "vuelta_1") %>%
mutate(
vuelta_1 = ifelse(
vuelta_1 == "nulos_blancos",
"nulosblancos",
vuelta_1
)
) %>%
rename(
ausente2 = ausente,
nulosblancos2 = nulos_blancos,
kast2 = kast,
jara2 = jara
) %>%
pivot_wider(
names_from = vuelta_1,
values_from = c(ausente2, nulosblancos2, kast2, jara2)
) %>%
mutate_if(is.numeric, round, digits = 3)
ptm_wide$comuna <- nombre_comuna
ptm_wide$n_original <- n_original
ptm_wide$n_consolidado <- n_consolidado
write_csv(
ptm_wide,
str_c(
"ptm/",
str_to_snake(nombre_comuna),
"_ptm.csv"
)
)
}
problemas <- c()
for (comuna in codigo_comuna$comuna) {
print(comuna)
tryCatch(
{
analizar_comuna(comuna)
},
error = function(e) {
problemas <- c(problemas, comuna)
}
)
}
